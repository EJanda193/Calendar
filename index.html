<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Weekly Calendar</title>
  <style>
    :root{
      --timeCol:80px;      /* left time labels width */
      --headerH:40px;      /* day header height (px) */
    }
    *{box-sizing:border-box}

    body{
      margin:0;background:#111;color:#fff;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      min-height:100vh;display:flex;flex-direction:column;
    }

    h1{margin:16px 0 8px;text-align:center}

    .controls{
      display:flex;justify-content:center;flex-wrap:wrap;gap:8px;
      padding:0 12px 10px;
    }
    .controls input,.controls select,.controls button{
      padding:6px 8px;font-size:14px;border:none;border-radius:6px;
    }
    .controls button{cursor:pointer}
    #add{background:#2e7d32;color:#fff}
    #save{background:#1976d2;color:#fff}
    #clear{background:#8e24aa;color:#fff}

    /* Wrapper fills all remaining viewport height */
    .calendar-wrap{
      position:relative;flex:1;min-height:0;
    }

    /* Background grid */
    .grid{
      position:absolute;inset:0;
      display:grid;
      grid-template-columns:var(--timeCol) repeat(7,1fr);
      /* header + 29 half-hour rows (8:00 → 10:00 PM inclusive); rows stretch with viewport */
      grid-template-rows:var(--headerH) repeat(29, 1fr);
      border-top:1px solid #333;border-left:1px solid #333;
      background:#151515;
    }
    .grid > div{
      border-right:1px solid #333;border-bottom:1px solid #222;
      display:flex;align-items:center;justify-content:center;font-size:12px;
    }
    .day-head{background:#222;font-weight:700}
    .time-cell{background:#101010;color:#ddd;justify-content:flex-end;padding-right:6px}

    /* Event overlay sits on top of the grid inside the same wrapper */
    .overlay{position:absolute;inset:0;pointer-events:none}
    .event{
      position:absolute;pointer-events:auto;
      border-radius:8px;padding:6px 22px 6px 8px;color:#000;font-size:12px;line-height:1.25;
      box-shadow:0 1px 6px rgba(0,0,0,.35);white-space:pre-line;border:1px solid rgba(0,0,0,.15);
      background:var(--bg);overflow:hidden;transition:box-shadow .15s ease;
    }
    .event:hover{ box-shadow:0 3px 10px rgba(0,0,0,.5); }
    .del{
      position:absolute;top:4px;right:4px;width:18px;height:18px;line-height:18px;text-align:center;
      border-radius:4px;background:rgba(0,0,0,.25);font-weight:700;color:#000;font-size:12px;cursor:pointer;
    }
    .del:hover{background:#e53935;color:#fff}
  </style>
</head>
<body>
  <h1>Weekly Calendar</h1>

  <div class="controls">
    <input id="code" placeholder="CIS*2030">
    <input id="type" placeholder="LEC">
    <input id="location" placeholder="Location (e.g. MACK 117)">
    <select id="day">
      <option>Mon</option><option>Tue</option><option>Wed</option>
      <option>Thu</option><option>Fri</option><option>Sat</option><option>Sun</option>
    </select>
    <input id="start-time" placeholder="1:30">
    <select id="start-meridian"><option>AM</option><option selected>PM</option></select>
    <input id="end-time" placeholder="2:20">
    <select id="end-meridian"><option>AM</option><option selected>PM</option></select>
    <button id="add">Add Course</button>
    <button id="save">Save PNG</button>
    <button id="clear">Clear All</button>
  </div>

  <div class="calendar-wrap" id="wrap">
    <!-- grid background -->
    <div class="grid" id="grid">
      <div></div>
      <div class="day-head">Mon</div><div class="day-head">Tue</div><div class="day-head">Wed</div>
      <div class="day-head">Thu</div><div class="day-head">Fri</div><div class="day-head">Sat</div><div class="day-head">Sun</div>
    </div>
    <!-- events overlay (aligned to wrapper) -->
    <div class="overlay" id="overlay"></div>
  </div>

  <!-- html2canvas for PNG export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    // ----- Build time labels every 30 min from 8:00 → 22:00 (10:00 PM) inclusive -----
    const grid = document.getElementById('grid');
    function fmt(h,m){const ampm=h>=12?'PM':'AM';const h12=((h+11)%12)+1;return `${h12}:${String(m).padStart(2,'0')} ${ampm}`;}
    for (let i = 0; i < 29; i++) {
      const hour = 8 + Math.floor(i/2);
      const mins = i%2 ? 30 : 0;
      const t = document.createElement('div');
      t.className='time-cell';
      t.textContent = fmt(hour, mins);
      grid.appendChild(t);
      for (let d=0; d<7; d++) grid.appendChild(document.createElement('div'));
    }

    // ----- Stable color per course code (PERSISTED) -----
    let colorMap = {};
    let colorIdx = 0;
    const palette = ['#a2d2ff','#caffbf','#ffc6ff','#ffd6a5','#bdb2ff','#9bf6ff','#ffadad','#e0ffcd','#ffe5ec'];
    function colorFor(code){
      const key = code.trim().toUpperCase();
      if(!colorMap[key]){ colorMap[key] = palette[colorIdx++ % palette.length]; saveState(); }
      return colorMap[key];
    }

    // ----- Time parsing -----
    function toDecimal(timeStr, meridian){
      const [hStr, mStr='0'] = timeStr.trim().split(':');
      let h = parseInt(hStr,10), m = parseInt(mStr,10);
      if (Number.isNaN(h) || Number.isNaN(m)) return NaN;
      const mer = meridian.toUpperCase();
      if(mer==='PM' && h!==12) h+=12;
      if(mer==='AM' && h===12) h=0;
      return h + m/60;
    }

    const overlay = document.getElementById('overlay');
    const wrap = document.getElementById('wrap');

    // -------- state + persistence ----------
    let events = [];
    const LS_KEY_EVENTS = 'calendar.events.v1';
    const LS_KEY_COLORS = 'calendar.colors.v1';
    const LS_KEY_COLORIDX = 'calendar.colorIdx.v1';

    function saveState(){
      localStorage.setItem(LS_KEY_EVENTS, JSON.stringify(events));
      localStorage.setItem(LS_KEY_COLORS, JSON.stringify(colorMap));
      localStorage.setItem(LS_KEY_COLORIDX, String(colorIdx));
    }
    function loadState(){
      try {
        const e = JSON.parse(localStorage.getItem(LS_KEY_EVENTS) || '[]');
        const c = JSON.parse(localStorage.getItem(LS_KEY_COLORS) || '{}');
        const i = parseInt(localStorage.getItem(LS_KEY_COLORIDX) || '0', 10);
        if (Array.isArray(e)) events = e;
        if (c && typeof c === 'object') colorMap = c;
        if (!Number.isNaN(i)) colorIdx = i;
      } catch(_) {}
    }

    // Layout & render (handles overlaps + full-height scaling)
    function renderEvents(){
      overlay.innerHTML = '';

      // sizing from live measurements to perfectly fill viewport
      const TIME_COL = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--timeCol')) || 80;
      const HEADER_H = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--headerH')) || 40;

      const wrapRect = wrap.getBoundingClientRect();
      const contentH = wrapRect.height - HEADER_H;    // vertical space for 8→22 (14 hours)
      const pixelsPerHour = contentH / 14;
      const dayWidth = (wrapRect.width - TIME_COL) / 7;

      // group by day
      for (let d=0; d<7; d++) {
        const dayEvents = events.filter(e => e.day === d).sort((a,b)=>a.start-b.start);

        // Build overlap clusters (scanline)
        let i = 0;
        while (i < dayEvents.length) {
          const cluster = [ dayEvents[i] ];
          let clusterEnd = dayEvents[i].end;
          let j = i + 1;
          while (j < dayEvents.length && dayEvents[j].start < clusterEnd) {
            cluster.push(dayEvents[j]);
            clusterEnd = Math.max(clusterEnd, dayEvents[j].end);
            j++;
          }

          const cols = cluster.length;
          const colWidth = dayWidth / cols;

          cluster.forEach((ev, k) => {
            const div = document.createElement('div');
            div.className = 'event';
            div.style.background = ev.color || colorFor(ev.code);

            const top = HEADER_H + (ev.start - 8) * pixelsPerHour;
            const height = (ev.end - ev.start) * pixelsPerHour;
            const left = TIME_COL + d * dayWidth + k * colWidth + 4; // inner padding
            const width = colWidth - 8;

            div.style.top = `${top}px`;
            div.style.height = `${height}px`;
            div.style.left = `${left}px`;
            div.style.width = `${width}px`;

            div.textContent = `${ev.code} ${ev.type}\n${ev.loc}`;

            // delete
            const del = document.createElement('div');
            del.className = 'del';
            del.textContent = '×';
            del.onclick = (e) => {
              e.stopPropagation();
              if (confirm('Remove this course?')) {
                events = events.filter(x => x !== ev);
                saveState();
                renderEvents();
              }
            };
            div.appendChild(del);

            overlay.appendChild(div);
          });

          i = j;
        }
      }
    }

    // Add course
    document.getElementById('add').addEventListener('click',()=>{
      const code = document.getElementById('code').value.trim();
      const type = document.getElementById('type').value.trim();
      const loc  = document.getElementById('location').value.trim() || 'Location';
      const dayStr = document.getElementById('day').value;
      const sT = document.getElementById('start-time').value;
      const sM = document.getElementById('start-meridian').value;
      const eT = document.getElementById('end-time').value;
      const eM = document.getElementById('end-meridian').value;

      if(!code || !type || !sT || !eT){ alert('Please fill all fields.'); return; }

      const start = toDecimal(sT, sM), end = toDecimal(eT, eM);
      if(isNaN(start) || isNaN(end) || end <= start){ alert('Check your times.'); return; }
      if(start < 8 || end > 22){ alert('Times must be between 8:00 AM and 10:00 PM.'); return; }

      const dayIndex = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].indexOf(dayStr);
      const evt = { code, type, loc, day: dayIndex, start, end, color: colorFor(code) };
      events.push(evt);
      saveState();
      renderEvents();
    });

    // Save PNG
    document.getElementById('save').addEventListener('click', async () => {
      const canvas = await html2canvas(wrap, { backgroundColor: null, scale: 2, useCORS: true });
      const link = document.createElement('a');
      link.download = 'calendar.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    });

    // Clear all
    document.getElementById('clear').addEventListener('click', () => {
      if (!confirm('Clear all courses and colors?')) return;
      events = [];
      colorMap = {};
      colorIdx = 0;
      saveState();
      renderEvents();
    });

    // Re-render on resize so scaling stays perfect
    window.addEventListener('resize', renderEvents);

    // ---- Boot: load from localStorage and render ----
    loadState();
    renderEvents();
  </script>
</body>
</html>
