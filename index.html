<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Weekly Calendar</title>
  <style>
    :root{
      --timeCol:80px;         /* left time labels width */
      --headerH:40px;         /* day header height */
      --halfHourH:30px;       /* 30 min row height */
      --hourH:60px;           /* derived (2 * halfHourH) */
    }
    *{box-sizing:border-box}

    body{
      margin:0;background:#111;color:#fff;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      min-height:100vh;display:flex;flex-direction:column;
    }

    h1{margin:16px 0 8px;text-align:center}

    .controls{
      display:flex;justify-content:center;flex-wrap:wrap;gap:8px;
      padding:0 12px 10px;
    }
    .controls input,.controls select,.controls button{
      padding:6px 8px;font-size:14px;border:none;border-radius:6px;
    }
    .controls button{cursor:pointer}
    #add{background:#2e7d32;color:#fff}
    #save{background:#1976d2;color:#fff}

    /* Wrapper fills all remaining viewport height */
    .calendar-wrap{
      position:relative;flex:1;min-height:0; /* makes it grow */
    }

    /* Background grid */
    .grid{
      position:absolute;inset:0; /* fill wrapper */
      display:grid;
      grid-template-columns:var(--timeCol) repeat(7,1fr);
      grid-template-rows:var(--headerH) repeat(29,var(--halfHourH)); /* 8:00 → 10:00 inclusive */
      border-top:1px solid #333;border-left:1px solid #333;
      background:#151515;
    }
    .grid > div{
      border-right:1px solid #333;border-bottom:1px solid #222;
      display:flex;align-items:center;justify-content:center;font-size:12px;
    }
    .day-head{background:#222;font-weight:700}
    .time-cell{background:#101010;color:#ddd;justify-content:flex-end;padding-right:6px}

    /* Event overlay sits on top of the grid inside the same wrapper */
    .overlay{position:absolute;inset:0;pointer-events:none}
    .event{
      position:absolute;pointer-events:auto;
      border-radius:8px;padding:6px 8px;color:#000;font-size:12px;line-height:1.25;
      box-shadow:0 1px 6px rgba(0,0,0,.35);white-space:pre-line;border:1px solid rgba(0,0,0,.15);

      /* horizontal: width of a single day column */
      width:calc((100% - var(--timeCol))/7 - 8px);
      left:calc(var(--timeCol) + var(--day) * ((100% - var(--timeCol))/7) + 4px);

      /* vertical */
      top:calc(var(--headerH) + (var(--start) - 8) * var(--hourH));
      height:calc((var(--end) - var(--start)) * var(--hourH));

      background:var(--bg);
    }
  </style>
</head>
<body>
  <h1>Weekly Calendar</h1>

  <div class="controls">
    <input id="code" placeholder="CIS*2030">
    <input id="type" placeholder="LEC">
    <input id="location" placeholder="Location (e.g. MACK 117)">
    <select id="day">
      <option>Mon</option><option>Tue</option><option>Wed</option>
      <option>Thu</option><option>Fri</option><option>Sat</option><option>Sun</option>
    </select>
    <input id="start-time" placeholder="1:30">
    <select id="start-meridian"><option>AM</option><option selected>PM</option></select>
    <input id="end-time" placeholder="2:20">
    <select id="end-meridian"><option>AM</option><option selected>PM</option></select>
    <button id="add">Add Course</button>
    <button id="save">Save PNG</button>
  </div>

  <div class="calendar-wrap" id="wrap">
    <!-- grid background -->
    <div class="grid" id="grid">
      <div></div>
      <div class="day-head">Mon</div><div class="day-head">Tue</div><div class="day-head">Wed</div>
      <div class="day-head">Thu</div><div class="day-head">Fri</div><div class="day-head">Sat</div><div class="day-head">Sun</div>
    </div>
    <!-- events overlay (aligned to wrapper) -->
    <div class="overlay" id="overlay"></div>
  </div>

  <!-- html2canvas for PNG export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    const grid = document.getElementById('grid');

    // Build time labels every 30 min from 8:00 → 22:00 (10:00 PM) inclusive
    function fmt(h, m){
      const ampm = h >= 12 ? 'PM' : 'AM';
      const h12 = ((h + 11) % 12) + 1;
      return `${h12}:${String(m).padStart(2,'0')} ${ampm}`;
    }
    for (let i = 0; i < 29; i++) {
      const hour = 8 + Math.floor(i/2);
      const mins = i%2 ? 30 : 0;
      const t = document.createElement('div');
      t.className='time-cell';
      t.textContent = fmt(hour, mins);
      grid.appendChild(t);
      for (let d=0; d<7; d++) grid.appendChild(document.createElement('div'));
    }

    // Stable color per course code
    const colorMap = {};
    const palette = ['#a2d2ff','#caffbf','#ffc6ff','#ffd6a5','#bdb2ff','#9bf6ff','#ffadad','#e0ffcd','#ffe5ec'];
    let colorIdx = 0;
    function colorFor(code){
      const key = code.trim().toUpperCase();
      if(!colorMap[key]) colorMap[key] = palette[colorIdx++ % palette.length];
      return colorMap[key];
    }

    function toDecimal(timeStr, meridian){
      const [hStr, mStr='0'] = timeStr.trim().split(':');
      let h = parseInt(hStr,10), m = parseInt(mStr,10);
      if (Number.isNaN(h) || Number.isNaN(m)) return NaN;
      const mer = meridian.toUpperCase();
      if(mer==='PM' && h!==12) h+=12;
      if(mer==='AM' && h===12) h=0;
      return h + m/60;
    }

    const overlay = document.getElementById('overlay');
    document.getElementById('add').addEventListener('click', () => {
      const code = document.getElementById('code').value.trim();
      const type = document.getElementById('type').value.trim();
      const loc  = document.getElementById('location').value.trim() || 'Location';
      const day  = document.getElementById('day').value;
      const sT   = document.getElementById('start-time').value;
      const sM   = document.getElementById('start-meridian').value;
      const eT   = document.getElementById('end-time').value;
      const eM   = document.getElementById('end-meridian').value;

      if(!code || !type || !sT || !eT){ alert('Please fill all fields.'); return; }

      const start = toDecimal(sT, sM);
      const end   = toDecimal(eT, eM);
      if(isNaN(start) || isNaN(end) || end <= start){ alert('Check your times.'); return; }
      if(start < 8 || end > 22){ alert('Times must be between 8:00 AM and 10:00 PM.'); return; }

      const dayIndex = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].indexOf(day);

      const ev = document.createElement('div');
      ev.className = 'event';
      ev.style.setProperty('--day', dayIndex);
      ev.style.setProperty('--start', start);
      ev.style.setProperty('--end', end);
      ev.style.setProperty('--bg', colorFor(code));
      ev.textContent = `${code} ${type}\n${loc}`;
      overlay.appendChild(ev);
    });

    // ---- Save calendar area as PNG ----
    document.getElementById('save').addEventListener('click', async () => {
      const wrap = document.getElementById('wrap'); // capture grid + overlay only
      // Use 2x for sharper output; transparent: false to keep dark bg
      const canvas = await html2canvas(wrap, {backgroundColor: null, scale: 2, useCORS: true});
      const link = document.createElement('a');
      link.download = 'calendar.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    });
  </script>
</body>
</html>
